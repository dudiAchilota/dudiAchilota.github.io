
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>××©×—×§ ×–×™×›×¨×•×Ÿ 4Ã—4</title>
  <style>
    :root{
      --bg1:#0f172a; --bg2:#1e293b; --acc1:#14b8a6; --acc2:#22d3ee; --danger:#ef4444; --ok:#22c55e;
      --glass: rgba(255,255,255,.08); --glass-2: rgba(255,255,255,.14); --border: rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35), 0 2px 8px rgba(0,0,0,.25);
      --radius: 18px; --radius-lg: 24px; --gap: 14px;
      --font: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
    }
    html, body{ height:100%; }
    body{ margin:0; font-family:var(--font); color:#e5e7eb;
      background: radial-gradient(1200px 600px at 75% -10%, #1f2937 0%, transparent 60%),
                  radial-gradient(1200px 600px at 15% 120%, #0e7490 0%, transparent 60%),
                  linear-gradient(160deg, var(--bg1), var(--bg2)); }
    .container{ max-width:1000px; margin:0 auto; padding: clamp(12px, 2vw, 24px); display:flex; flex-direction:column; gap:16px; }
    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    h1{ font-size:clamp(22px, 3.5vw, 36px); margin:0; letter-spacing:.3px; }
    .controls{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; background:var(--glass); border:1px solid var(--border); border-radius:var(--radius); padding:10px 12px; box-shadow:var(--shadow); }
    .btn, .input, .select{ background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04)); border:1px solid var(--border); color:#e5e7eb; padding:10px 14px; border-radius:12px; outline:none; transition:.2s ease; }
    .btn{ cursor:pointer; } .btn:hover{ transform: translateY(-1px); box-shadow: 0 10px 18px rgba(0,0,0,.25); }
    .btn.primary{ background: linear-gradient(180deg, var(--acc2), var(--acc1)); color:#04202a; border-color: transparent; font-weight:700; }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; filter:grayscale(.3); transform:none; }

    .game-wrap{ display:grid; grid-template-columns: 160px 1fr 160px; gap: clamp(10px,2vw,16px); align-items:stretch; }
    @media (max-width: 860px){ .game-wrap{ grid-template-columns: 1fr; } }

    .panel{ background:var(--glass); border:1px solid var(--border); border-radius:var(--radius-lg); padding:14px; box-shadow:var(--shadow); display:flex; flex-direction:column; align-items:center; gap:10px; min-height:120px; position:relative; }
    .panel h2{ font-size: clamp(16px, 2.5vw, 20px); margin:2px 0 0; font-weight:800; }
    .score{ font-size: clamp(20px, 4.5vw, 32px); font-weight:900; letter-spacing:1px; }
    .badge{ font-size:12px; opacity:.9; padding:3px 8px; border-radius:999px; border:1px solid var(--border); background:var(--glass-2); }
    .turn-btn{ width:100%; font-weight:700; }
    .waiting{ animation: pulse 1.1s ease-in-out infinite; }
    @keyframes pulse{ 0%{transform:scale(1);} 50%{transform:scale(1.03);} 100%{transform:scale(1);} }

    .name-edit{ display:flex; gap:6px; width:100%; }
    .name-edit .input{ width:100%; }

    .board{ position:relative; width:100%; aspect-ratio: 1/1; background: linear-gradient(160deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid var(--border); border-radius: var(--radius-lg); box-shadow: var(--shadow); padding: clamp(8px, 2vw, 16px); display:grid; grid-template-columns: repeat(4, 1fr); gap: var(--gap); user-select: none; touch-action: manipulation; }
    @media (max-width: 860px){ .board{ aspect-ratio: auto; grid-template-columns: repeat(4, 1fr); } }

    .card{ position:relative; perspective: 900px; border-radius: 16px; isolation:isolate; }
    .card.disabled{ pointer-events:none; }
    .card .inner{ position:absolute; inset:0; transform-style:preserve-3d; transition: transform .5s cubic-bezier(.2,.7,.2,1); border-radius: 16px; box-shadow: 0 10px 20px rgba(0,0,0,.25); }
    .card.flipped .inner{ transform: rotateY(180deg); }
    .face{ position:absolute; inset:0; border-radius: 16px; backface-visibility:hidden; overflow:hidden; display:flex; align-items:center; justify-content:center; }
    .front{ transform: rotateY(180deg); background:#0b132b; }
    .front img{ width:100%; height:100%; object-fit:cover; display:block; }
    .back{ background: radial-gradient(120px 60px at -10% -10%, rgba(255,255,255,.14), transparent 60%), radial-gradient(180px 80px at 120% 120%, rgba(255,255,255,.06), transparent 60%), linear-gradient(145deg, #111827, #0b1022); border:1px solid rgba(255,255,255,.12); position:relative; }
    .back::after{ content:""; position:absolute; inset:10%; border-radius:12px; border:1px dashed rgba(255,255,255,.15); }

    .footer{ display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; background:var(--glass); border:1px solid var(--border); border-radius:var(--radius); padding:8px 12px; box-shadow:var(--shadow); }
    .stat{ font-size:14px; opacity:.9; }

    /* Modal + Home screen */
    .overlay{ position: fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(6,8,15,.55); backdrop-filter: blur(2px); z-index:50; }
    .overlay.open{ display:flex; }
    .card-modal{ background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04)); border:1px solid var(--border); border-radius: 20px; padding: 18px; width:min(560px, 92vw); box-shadow: var(--shadow); text-align:center; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .pill{ background:var(--glass); border:1px solid var(--border); border-radius:14px; padding:10px; font-weight:700; }

    .toast{ position:fixed; bottom:16px; right:16px; background:#0b1022; border:1px solid var(--border); color:#e5e7eb; padding:10px 12px; border-radius:12px; box-shadow: var(--shadow); display:none; z-index:60; }
    .toast.show{ display:block; animation: fadeToast 3.6s ease forwards; }
    @keyframes fadeToast{ 0%{opacity:0; transform: translateY(8px);} 8%{opacity:1; transform: translateY(0);} 85%{opacity:1;} 100%{opacity:0; transform: translateY(8px);} }
  
  /* ×œ×•×— ×”××©×—×§ ×¨×¡×¤×•× ×¡×™×‘×™ */
.board {
  position: relative;
  width: 100%;
  max-width: 500px;         /* ××’×‘×œ×” ×›×“×™ ×œ× ×œ×”×ª×¤×–×¨ ×‘××¡×›×™× ×’×“×•×œ×™× ××“×™ */
  margin: 0 auto;
  display: grid;
  grid-template-columns: repeat(4, minmax(60px, 1fr));
  gap: var(--gap);
  background: linear-gradient(160deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow);
  padding: clamp(6px, 2vw, 16px);
}

.card {
  aspect-ratio: 1/1;        /* ×›×œ ×§×œ×£ ×¨×™×‘×•×¢×™ */
  border-radius: 12px;
}

/* ×¤×× ×œ×™× ×‘××¡×›×™× ×§×˜× ×™× ×¢×•×‘×¨×™× ×œ××˜×” */
@media (max-width: 700px) {
  .game-wrap {
    grid-template-columns: 1fr;   /* ×©×•×¨×” ××—×ª */
    grid-template-rows: auto auto auto;
  }
  #p1Panel, #p2Panel {
    width: 100%;
    flex-direction: row;
    justify-content: space-between;
    gap: 12px;
    padding: 10px;
  }
  .score {
    font-size: clamp(18px, 5vw, 28px);
  }
}

/* ×›×¤×ª×•×¨×™× ××•×ª×××™× ×œ×˜××¦' */
.btn, .input {
  padding: 12px 16px;
  font-size: clamp(14px, 4vw, 18px);
}

/* ×˜×§×¡×˜×™× ×§×˜× ×™× ××•×ª×××™× */
h1 {
  font-size: clamp(20px, 6vw, 32px);
}

  </style>
</head>
<body>
  <div class="container" id="app">
    <header>
      <h1>ğŸ§  ××©×—×§ ×–×™×›×¨×•×Ÿ 4Ã—4</h1>
      <div class="controls">
        <button id="homeBtn" class="btn">â¬…ï¸ ××¡×š ×¨××©×™</button>
        <button id="newGameBtn" class="btn primary">â™»ï¸ ××©×—×§ ×—×“×©</button>
      </div>
    </header>

    <div class="game-wrap">
      <!-- Player 1 panel -->
      <aside class="panel" id="p1Panel">
        <span class="badge">×©×—×§×Ÿ 1</span>
        <div class="name-edit">
          <input id="p1Input" class="input" placeholder="×©× ×©×—×§×Ÿ 1" />
          <button id="p1Save" class="btn">×©××•×¨</button>
        </div>
        <h2 id="p1Name">×©×—×§×Ÿ 1</h2>
        <div class="score" id="p1Score">0</div>
        <button class="btn turn-btn" id="p1TurnBtn">×”×ª×—×œ ×ª×•×¨</button>
      </aside>

      <!-- Board -->
      <main class="board" id="board" aria-label="×œ×•×— ×”××©×—×§"></main>

      <!-- Player 2 panel -->
      <aside class="panel" id="p2Panel">
        <span class="badge">×©×—×§×Ÿ 2</span>
        <div class="name-edit">
          <input id="p2Input" class="input" placeholder="×©× ×©×—×§×Ÿ 2" />
          <button id="p2Save" class="btn">×©××•×¨</button>
        </div>
        <h2 id="p2Name">×©×—×§×Ÿ 2</h2>
        <div class="score" id="p2Score">0</div>
        <button class="btn turn-btn" id="p2TurnBtn">×”×ª×—×œ ×ª×•×¨</button>
      </aside>
    </div>

    <div class="footer">
      <div id="status">×‘×—×¨ ××¦×‘ ×‘××¡×š ×”×¨××©×™ ×•×”×ª×—×œ ××©×—×§.</div>
      <div class="stat">â±ï¸ ×–××Ÿ: <span id="timeEl">00:00</span></div>
      <div class="stat">ğŸ” ×ª×•×¨×™×: <span id="turnsEl">0</span></div>
    </div>
  </div>

  <!-- HOME (××¡×š ×¨××©×™) -->
  <div class="overlay open" id="home">
    <div class="card-modal">
      <div class="badge">×ª×¤×¨×™×˜ ×¨××©×™</div>
      <h3>×‘×—×¨ ××¦×‘ ××©×—×§</h3>
      <div style="margin:10px 0 12px;" class="grid2">
        <button class="btn primary" id="chooseSingle">×©×—×§×Ÿ ×™×—×™×“</button>
        <button class="btn primary" id="chooseTwo">×©× ×™ ×©×—×§× ×™×</button>
      </div>
      <div class="grid2">
        <div>
          <div class="badge">×©× ×©×—×§×Ÿ 1</div>
          <input id="homeP1" class="input" placeholder="×©×—×§×Ÿ 1" />
        </div>
        <div>
          <div class="badge">×©× ×©×—×§×Ÿ 2</div>
          <input id="homeP2" class="input" placeholder="×©×—×§×Ÿ 2" />
        </div>
      </div>
      <div style="margin-top:12px; display:flex; gap:10px; justify-content:center;">
        <button class="btn" id="homeStart">×”×ª×—×œ</button>
      </div>
    </div>
  </div>

  <!-- END MODAL -->
  <div class="overlay" id="endModal" role="dialog" aria-modal="true">
    <div class="card-modal">
      <div class="badge">×¡×™×•× ××©×—×§</div>
      <h3 id="endTitle">×›×œ ×”×›×‘×•×“!</h3>
      <div class="grid2" id="endSummary" style="margin:12px 0 8px;"></div>
      <div style="margin-top:8px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
        <button class="btn primary" id="playAgain">××©×—×§ ×—×“×©</button>
        <button class="btn" id="backHome">××¡×š ×¨××©×™</button>
        <button class="btn" id="closeModal">×¡×’×•×¨</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /******************************
     * ×”×’×“×¨ ××ª ×¨×©×™××ª ×”×ª××•× ×•×ª ×›××Ÿ *
     ******************************/
        const IMAGE_URLS = ['photos/1.jpeg','photos/8.jpeg','photos/11.jpeg','photos/15.jpeg',
                            'photos/20.jpeg','photos/100.png','photos/102.jpeg','photos/104.jpeg',
    ];
  

    const boardEl = document.getElementById('board');
    const newGameBtn = document.getElementById('newGameBtn');
    const homeBtn = document.getElementById('homeBtn');

    const p1ScoreEl = document.getElementById('p1Score');
    const p2ScoreEl = document.getElementById('p2Score');
    const p1TurnBtn = document.getElementById('p1TurnBtn');
    const p2TurnBtn = document.getElementById('p2TurnBtn');
    const p1NameEl = document.getElementById('p1Name');
    const p2NameEl = document.getElementById('p2Name');
    const p1Input = document.getElementById('p1Input');
    const p2Input = document.getElementById('p2Input');
    const p1Save = document.getElementById('p1Save');
    const p2Save = document.getElementById('p2Save');

    const statusEl = document.getElementById('status');
    const timeEl = document.getElementById('timeEl');
    const turnsEl = document.getElementById('turnsEl');

    const homeOverlay = document.getElementById('home');
    const endModal = document.getElementById('endModal');
    const endTitle = document.getElementById('endTitle');
    const endSummary = document.getElementById('endSummary');

    const chooseSingle = document.getElementById('chooseSingle');
    const chooseTwo = document.getElementById('chooseTwo');
    const homeStart = document.getElementById('homeStart');
    const homeP1 = document.getElementById('homeP1');
    const homeP2 = document.getElementById('homeP2');

    const playAgainBtn = document.getElementById('playAgain');
    const backHomeBtn = document.getElementById('backHome');
    const closeModalBtn = document.getElementById('closeModal');

    const toastEl = document.getElementById('toast');

    let state = {
      deck: [], // {id, pairId, url, matched}
      firstPick: null,
      secondPick: null,
      lock: true,
      mode: 'single',
      currentPlayer: 1,
      awaitingStart: false, // ×‘××¦×‘ ×©× ×™ ×©×—×§× ×™×: ×—×•×‘×” ×œ×œ×—×•×¥ "×”×ª×—×œ ×ª×•×¨"
      scores: {1:0, 2:0},
      turns: 0,
      startTime: null,
      timerInterval: null,
      fiveSecTimer: null,
      names: {1:'×©×—×§×Ÿ 1', 2:'×©×—×§×Ÿ 2'},
      pendingModeChoice: 'single'
    };

    function showToast(msg){ toastEl.textContent = msg; toastEl.classList.add('show'); setTimeout(()=> toastEl.classList.remove('show'), 3600); }
    function shuffle(arr){ for(let i=arr.length-1; i>0; i--){ const j = Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }
    function pickRandom(arr,n){ const copy=[...arr]; shuffle(copy); return copy.slice(0,n); }
    function hashCode(str){ let h=0; for(let i=0;i<str.length;i++){ h=((h<<5)-h)+str.charCodeAt(i); h|=0; } return h; }
    function makeColorDataURI(seed){ const hue=Math.abs(hashCode(seed))%360; const hue2=(hue+40)%360; const svg=`<?xml version="1.0" encoding="UTF-8"?><svg xmlns='http://www.w3.org/2000/svg' width='400' height='400'><defs><linearGradient id='g' x1='0' x2='1' y1='0' y2='1'><stop offset='0%' stop-color='hsl(${hue},70%,55%)'/><stop offset='100%' stop-color='hsl(${hue2},70%,50%)'/></linearGradient></defs><rect width='100%' height='100%' fill='url(#g)'/><circle cx='200' cy='200' r='120' fill='rgba(255,255,255,.18)'/><text x='50%' y='54%' text-anchor='middle' font-size='120' font-family='Verdana' fill='rgba(255,255,255,.7)'>â˜…</text></svg>`; return 'data:image/svg+xml;utf8,'+encodeURIComponent(svg); }

    function prepareImages(){
      let selected = [];
      if(IMAGE_URLS.length >= 8){ selected = pickRandom(IMAGE_URLS, 8); }
      else if(IMAGE_URLS.length > 0){ selected = [...IMAGE_URLS]; for(let i=IMAGE_URLS.length;i<8;i++){ selected.push(makeColorDataURI('fill'+i+Date.now())); } showToast('×™×© ×¤×—×•×ª ×Ö¾8 ×ª××•× ×•×ª â€“ ×”×©×œ×× ×• ××•×˜×•××˜×™×ª.'); }
      else { for(let i=0;i<8;i++) selected.push(makeColorDataURI('empty'+i)); showToast('×œ× ×”×•×–× ×• ×ª××•× ×•×ª â€“ ××©×—×§ ×¢× ××™×™×§×•× ×™× ×¦×‘×¢×•× ×™×™×.'); }
      return selected;
    }

    function buildDeck(){
      const imgs = prepareImages();
      const base = imgs.map((url, idx)=> ({ pairId: 'p'+idx, url }));
      const doubled = base.flatMap(item=> ([
        { id: item.pairId+'a', pairId: item.pairId, url: item.url, matched:false },
        { id: item.pairId+'b', pairId: item.pairId, url: item.url, matched:false },
      ]));
      return shuffle(doubled);
    }

    function renderBoard(){
      boardEl.innerHTML = '';
      state.deck.forEach((card, idx)=>{
        const cell = document.createElement('div');
        cell.className = 'card';
        cell.dataset.id = card.id; cell.dataset.index = idx; cell.setAttribute('aria-label','×§×œ×£');
        cell.innerHTML = `<div class="inner"><div class="face front"><img alt="×ª××•× ×”" loading="lazy" src="${card.url}"/></div><div class="face back"></div></div>`;
        cell.addEventListener('click', onCardClick, { passive:true });
        boardEl.appendChild(cell);
      });
      updateBoardInteractivity();
    }

    function startTimerIfNeeded(){
      if(state.startTime) return;
      state.startTime = Date.now();
      state.timerInterval = setInterval(()=>{
        const diff = Date.now() - state.startTime;
        timeEl.textContent = formatDuration(diff);
      }, 200);
    }

    function stopTimer(){ if(state.timerInterval){ clearInterval(state.timerInterval); state.timerInterval=null; } }

    function formatDuration(ms){
      const totalSec = Math.floor(ms/1000);
      const s = totalSec % 60;
      const m = Math.floor(totalSec/60) % 60;
      const h = Math.floor(totalSec/3600);
      const pad=n=> String(n).padStart(2,'0');
      return h>0 ? `${pad(h)}:${pad(m)}:${pad(s)}` : `${pad(m)}:${pad(s)}`;
    }

    function onCardClick(e){
      if(state.lock) return;
      if(state.mode==='two' && state.awaitingStart) return; // ×—×•×‘×” ×œ×œ×—×•×¥ ×›×¤×ª×•×¨ ×ª×•×¨

      startTimerIfNeeded();

      const el = e.currentTarget;
      const idx = Number(el.dataset.index);
      const card = state.deck[idx];
      if(card.matched) return;
      if(state.firstPick && state.firstPick.id===card.id) return; // ××•×ª×• ×§×œ×£

      flipCard(el, true);
      if(!state.firstPick){
        state.firstPick = { idx, id: card.id, pairId: card.pairId };
        return;
      }

      // second pick
      state.secondPick = { idx, id: card.id, pairId: card.pairId };
      state.lock = true; // × ×¢×œ ×‘×–××Ÿ ×—×©×™×¤×”

      state.turns++; turnsEl.textContent = state.turns; // ×›×œ ×©×ª×™ ×‘×—×™×¨×•×ª = ×ª×•×¨

      // ×”×©××¨ 3 ×©× ×™×•×ª ×’×œ×•×™
      clearTimeout(state.fiveSecTimer);
      state.fiveSecTimer = setTimeout(resolveTwoCards, 3000);
      updateStatus('×××ª×™×Ÿ 3 ×©× ×™×•×ª ×œ×¤× ×™ ×¡×’×™×¨×”/××™×©×•×¨â€¦');
    }

    function flipCard(cardEl, show){ if(!cardEl) return; cardEl.classList.toggle('flipped', show); }

    function resolveTwoCards(){
      const a = state.firstPick, b = state.secondPick;
      if(!a || !b) { state.lock=false; return; }
      const aEl = boardEl.querySelector(`.card[data-index="${a.idx}"]`);
      const bEl = boardEl.querySelector(`.card[data-index="${b.idx}"]`);
      const isMatch = a.pairId === b.pairId;

      if(isMatch){
        state.deck[a.idx].matched = true; state.deck[b.idx].matched = true;
        setTimeout(()=>{ aEl.classList.add('disabled'); bEl.classList.add('disabled'); }, 120);
        if(state.mode==='two'){ state.scores[state.currentPlayer]++; updateScores(); }
      } else {
        flipCard(aEl, false); flipCard(bEl, false);
      }

      state.firstPick = null; state.secondPick = null;

      // ×‘×“×™×§×ª ×¡×™×•×
      const done = state.deck.every(c=>c.matched);
      if(done){
        state.lock = true; stopTimer(); setTimeout(showEndModal, 500);
        return;
      }

      if(state.mode==='two'){
        // ×ª××™×“ ×¢×•×‘×¨×™× ×©×—×§×Ÿ ××—×¨×™ ×©× ×™ ×§×œ×¤×™× (×œ×¤×™ ×”×“×¨×™×©×”)
        togglePlayer();
        state.awaitingStart = true; // ×œ×—×™×¦×” × ×“×¨×©×ª ×›×“×™ ×œ×”×ª×—×™×œ
        updateBoardInteractivity(); updatePanelsActive(); updateStatus();
      } else {
        state.lock = false; updateStatus('×”××©×š ××©×—×§');
      }
    }

    function togglePlayer(){ state.currentPlayer = (state.currentPlayer===1?2:1); updatePanelsActive(); }
    function updateScores(){ p1ScoreEl.textContent = state.scores[1]; p2ScoreEl.textContent = state.scores[2]; }

    function updatePanelsActive(){
      const isTwo = state.mode==='two';
      document.getElementById('p1Panel').style.opacity = isTwo? (state.currentPlayer===1? '1' : '.85') : '1';
      document.getElementById('p2Panel').style.opacity = isTwo? (state.currentPlayer===2? '1' : '.85') : '1';
      p1TurnBtn.classList.toggle('waiting', isTwo && state.awaitingStart && state.currentPlayer===1);
      p2TurnBtn.classList.toggle('waiting', isTwo && state.awaitingStart && state.currentPlayer===2);
      p1TurnBtn.disabled = !(isTwo && state.awaitingStart && state.currentPlayer===1);
      p2TurnBtn.disabled = !(isTwo && state.awaitingStart && state.currentPlayer===2);
    }

    function updateBoardInteractivity(){
      if(state.mode==='two' && state.awaitingStart){ boardEl.style.pointerEvents = 'none'; boardEl.style.filter = 'grayscale(0.15)'; }
      else { boardEl.style.pointerEvents = state.lock? 'none' : 'auto'; boardEl.style.filter = 'none'; }
    }

    function updateStatus(custom){
      if(custom){ statusEl.textContent = custom; return; }
      if(state.mode==='two'){
        const who = state.currentPlayer===1? state.names[1] : state.names[2];
        statusEl.textContent = state.awaitingStart ? `×ª×•×¨ ${who} â€” ×œ×—×¥ "×”×ª×—×œ ×ª×•×¨"` : `×ª×•×¨ ×¤×¢×™×œ: ${who}`;
      } else { statusEl.textContent = '××¦×‘: ×©×—×§×Ÿ ×™×—×™×“'; }
    }

    function startTurn(player){
      if(state.mode!=='two') return;
      if(player !== state.currentPlayer) return;
      state.awaitingStart = false; state.lock = false;
      updatePanelsActive(); updateBoardInteractivity(); updateStatus();
    }

    function newGame(){
      state.deck = buildDeck();
      state.firstPick = state.secondPick = null;
      state.lock = (state.mode==='two');
      state.currentPlayer = 1;
      state.awaitingStart = (state.mode==='two');
      state.scores = {1:0, 2:0};
      state.turns = 0; turnsEl.textContent = '0';
      stopTimer(); state.startTime = null; timeEl.textContent = '00:00';
      updateScores(); renderBoard(); updatePanelsActive(); updateBoardInteractivity(); updateStatus();
    }

    function showEndModal(){
      endSummary.innerHTML = '';
      const duration = state.startTime ? Date.now() - state.startTime : 0;
      const durationStr = formatDuration(duration);
      const turnsStr = state.turns;

      if(state.mode==='two'){
        const s1 = state.scores[1], s2 = state.scores[2];
        endTitle.textContent = (s1===s2)? '×ª×™×§×•! ×™×¤×” ×××•×“' : (s1>s2? `${state.names[1]} × ×™×¦×—! ğŸ‰` : `${state.names[2]} × ×™×¦×—! ğŸ‰`);
        endSummary.innerHTML = `
          <div class="pill">${state.names[1]}: ${s1} × ×§×³</div>
          <div class="pill">${state.names[2]}: ${s2} × ×§×³</div>
          <div class="pill">â±ï¸ ×–××Ÿ: ${durationStr}</div>
          <div class="pill">ğŸ” ×ª×•×¨×™×: ${turnsStr}</div>
        `;
      } else {
        const found = state.deck.filter(c=>c.matched).length/2;
        endTitle.textContent = '×›×œ ×”×›×‘×•×“!';
        endSummary.innerHTML = `
          <div class="pill">×–×•×’×•×ª ×©××¦××ª: ${found} / 8</div>
          <div class="pill">â±ï¸ ×–××Ÿ: ${durationStr}</div>
          <div class="pill">ğŸ” ×ª×•×¨×™×: ${turnsStr}</div>
        `;
      }
      endModal.classList.add('open');
    }

    // ------- HOME (×ª×¤×¨×™×˜ ×¨××©×™) -------
    chooseSingle.addEventListener('click', ()=>{ state.pendingModeChoice='single'; showToast('××¦×‘: ×©×—×§×Ÿ ×™×—×™×“'); });
    chooseTwo.addEventListener('click', ()=>{ state.pendingModeChoice='two'; showToast('××¦×‘: ×©× ×™ ×©×—×§× ×™×'); });
    homeStart.addEventListener('click', ()=>{
      state.mode = state.pendingModeChoice || 'single';
      // ×©××•×ª ××”×ª×¤×¨×™×˜ (×× ××•×œ××•)
      const n1 = homeP1.value.trim(); const n2 = homeP2.value.trim();
      if(n1) state.names[1]=n1; if(n2) state.names[2]=n2;
      applyNamesToUI();
      homeOverlay.classList.remove('open');
      newGame();
    });

    homeBtn.addEventListener('click', ()=>{ homeOverlay.classList.add('open'); stopTimer(); });

    // ×©××™×¨×ª ×©××•×ª ×‘×¤×× ×œ×™×
    p1Save.addEventListener('click', ()=>{ const v=p1Input.value.trim(); if(v){ state.names[1]=v; applyNamesToUI(); }});
    p2Save.addEventListener('click', ()=>{ const v=p2Input.value.trim(); if(v){ state.names[2]=v; applyNamesToUI(); }});
    function applyNamesToUI(){ p1NameEl.textContent = state.names[1]; p2NameEl.textContent = state.names[2]; }

    // ×›×¤×ª×•×¨×™ ×ª×•×¨
    p1TurnBtn.addEventListener('click', ()=> startTurn(1));
    p2TurnBtn.addEventListener('click', ()=> startTurn(2));

    // ××©×—×§ ×—×“×© / ××•×“××œ ×¡×™×•×
    newGameBtn.addEventListener('click', newGame);
    document.getElementById('playAgain').addEventListener('click', ()=>{ endModal.classList.remove('open'); newGame(); });
    backHomeBtn.addEventListener('click', ()=>{ endModal.classList.remove('open'); homeOverlay.classList.add('open'); });
    closeModalBtn.addEventListener('click', ()=> endModal.classList.remove('open'));

    // ×¢×–×¨×” ×§×˜× ×” ×‘×”×ª×—×œ×”
    updateStatus();
  </script>
</body>
</html>
